<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>remote - crespo.world</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <style>
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      background: #000;
      color: #0f0;
      font-family: monospace;
      margin: 0;
      padding: 1em;
      min-height: 100vh;
    }
    
    nav {
      margin-bottom: 1em;
      text-align: center;
    }
    
    nav a {
      color: #0f0;
      text-decoration: none;
      margin: 0 0.5em;
      font-weight: bold;
      font-size: 0.9em;
    }
    
    nav a:hover {
      text-decoration: underline;
    }
    
    h1 {
      font-size: 1.5em;
      margin: 0.5em 0;
      text-align: center;
      text-shadow: 0 0 10px #0f0;
    }
    
    .container {
      max-width: 400px;
      margin: 0 auto;
    }
    
    /* Status indicator */
    .status-bar {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5em;
      margin-bottom: 1em;
      padding: 0.5em;
      border: 1px solid #0f0;
      border-radius: 5px;
      background: #111;
    }
    
    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #f00;
      transition: background 0.3s;
    }
    
    .status-dot.connected {
      background: #0f0;
      box-shadow: 0 0 10px #0f0;
    }
    
    .status-text {
      font-size: 0.9em;
    }
    
    /* Settings panel */
    .settings-panel {
      background: #111;
      border: 2px solid #0f0;
      border-radius: 10px;
      padding: 1em;
      margin-bottom: 1em;
    }
    
    .settings-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      user-select: none;
    }
    
    .settings-header h2 {
      margin: 0;
      font-size: 1em;
    }
    
    .settings-toggle {
      font-size: 1.2em;
      transition: transform 0.3s;
    }
    
    .settings-toggle.open {
      transform: rotate(180deg);
    }
    
    .settings-content {
      display: none;
      margin-top: 1em;
    }
    
    .settings-content.open {
      display: block;
    }
    
    .form-group {
      margin-bottom: 1em;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 0.3em;
      font-size: 0.9em;
    }
    
    .form-group input {
      width: 100%;
      padding: 0.7em;
      background: #000;
      color: #0f0;
      border: 2px solid #0f0;
      border-radius: 5px;
      font-family: monospace;
      font-size: 1em;
    }
    
    .form-group input:focus {
      outline: none;
      box-shadow: 0 0 10px #0f0;
    }
    
    .form-group input::placeholder {
      color: #060;
    }
    
    .btn {
      background: #000;
      color: #0f0;
      border: 2px solid #0f0;
      padding: 0.7em 1em;
      font-family: monospace;
      font-size: 0.9em;
      cursor: pointer;
      border-radius: 5px;
      transition: all 0.2s;
      user-select: none;
    }
    
    .btn:hover {
      background: #0f0;
      color: #000;
    }
    
    .btn:active {
      transform: scale(0.95);
      box-shadow: 0 0 15px #0f0;
    }
    
    .btn-row {
      display: flex;
      gap: 0.5em;
    }
    
    .btn-row .btn {
      flex: 1;
    }
    
    .help-text {
      font-size: 0.8em;
      color: #080;
      margin-top: 0.5em;
    }
    
    .error-msg {
      color: #f00;
      font-size: 0.9em;
      margin-top: 0.5em;
      display: none;
    }
    
    .error-msg.show {
      display: block;
    }
    
    .success-msg {
      color: #0f0;
      font-size: 0.9em;
      margin-top: 0.5em;
      display: none;
    }
    
    .success-msg.show {
      display: block;
    }
    
    /* Remote control layout */
    .remote {
      background: linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%);
      border: 3px solid #0f0;
      border-radius: 20px;
      padding: 1.5em 1em;
      box-shadow: 0 0 20px rgba(0, 255, 0, 0.2);
    }
    
    .remote-section {
      margin-bottom: 1.5em;
    }
    
    .remote-section:last-child {
      margin-bottom: 0;
    }
    
    /* Remote buttons */
    .remote-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(145deg, #222 0%, #111 100%);
      color: #0f0;
      border: 2px solid #0f0;
      border-radius: 10px;
      font-family: monospace;
      font-size: 1em;
      cursor: pointer;
      transition: all 0.15s;
      user-select: none;
      -webkit-user-select: none;
      touch-action: manipulation;
      min-height: 50px;
      padding: 0.5em;
    }
    
    .remote-btn:hover {
      background: linear-gradient(145deg, #333 0%, #1a1a1a 100%);
    }
    
    .remote-btn:active, .remote-btn.pressed {
      background: #0f0;
      color: #000;
      box-shadow: 0 0 20px #0f0;
      transform: scale(0.95);
    }
    
    .remote-btn.power {
      background: linear-gradient(145deg, #300 0%, #200 100%);
      border-color: #f00;
      color: #f00;
    }
    
    .remote-btn.power:active, .remote-btn.power.pressed {
      background: #f00;
      color: #000;
      box-shadow: 0 0 20px #f00;
    }
    
    /* Top row - Power and Input */
    .top-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1em;
    }
    
    /* Volume and Channel rows */
    .vol-ch-row {
      display: grid;
      grid-template-columns: 1fr 2fr 1fr;
      gap: 0.5em;
      align-items: center;
    }
    
    .vol-ch-label {
      text-align: center;
      font-size: 0.8em;
      color: #080;
    }
    
    .vol-ch-btns {
      display: flex;
      flex-direction: column;
      gap: 0.3em;
    }
    
    .vol-ch-btns .remote-btn {
      min-height: 45px;
    }
    
    /* D-pad */
    .dpad-container {
      display: flex;
      justify-content: center;
    }
    
    .dpad {
      display: grid;
      grid-template-columns: repeat(3, 60px);
      grid-template-rows: repeat(3, 60px);
      gap: 5px;
    }
    
    .dpad .remote-btn {
      min-height: 60px;
      font-size: 1.5em;
    }
    
    .dpad-center {
      background: linear-gradient(145deg, #040 0%, #020 100%) !important;
      border-radius: 50% !important;
    }
    
    .dpad-center:active, .dpad-center.pressed {
      background: #0f0 !important;
    }
    
    .dpad-empty {
      visibility: hidden;
    }
    
    /* Navigation row */
    .nav-row {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.5em;
    }
    
    /* Number pad */
    .numpad {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.5em;
    }
    
    .numpad .remote-btn {
      min-height: 55px;
      font-size: 1.3em;
    }
    
    /* Playback controls */
    .playback-row {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 0.5em;
    }
    
    .playback-row .remote-btn {
      min-height: 45px;
      font-size: 1.2em;
    }
    
    /* Menu row */
    .menu-row {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.5em;
    }
    
    /* Quick Apps section */
    .quick-apps {
      display: grid;
      grid-template-columns: 1fr;
      gap: 0.5em;
    }
    
    .remote-btn.peacock {
      background: linear-gradient(145deg, #000 0%, #1a1a2e 100%);
      border-color: #ff6b35;
      color: #fff;
      min-height: 60px;
      font-size: 1em;
      position: relative;
      overflow: hidden;
    }
    
    .remote-btn.peacock::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #ff6b35, #f7c59f, #2ec4b6, #3d5a80, #9b5de5);
    }
    
    .remote-btn.peacock:active, .remote-btn.peacock.pressed {
      background: linear-gradient(145deg, #ff6b35 0%, #f7c59f 100%);
      color: #000;
      box-shadow: 0 0 20px #ff6b35;
    }
    
    .peacock-icon {
      font-size: 1.5em;
      margin-right: 0.3em;
    }
    
    .app-subtitle {
      font-size: 0.7em;
      opacity: 0.8;
      display: block;
      margin-top: 0.2em;
    }
    
    /* Icon styles */
    .icon {
      font-size: 1.3em;
    }
    
    /* CORS warning */
    .cors-notice {
      background: #220;
      border: 1px solid #ff0;
      border-radius: 5px;
      padding: 0.8em;
      margin-bottom: 1em;
      font-size: 0.8em;
      color: #ff0;
    }
    
    .cors-notice summary {
      cursor: pointer;
      font-weight: bold;
    }
    
    .cors-notice p {
      margin: 0.5em 0 0 0;
      color: #cc0;
    }
    
    /* Loading spinner */
    .loading {
      display: inline-block;
      width: 12px;
      height: 12px;
      border: 2px solid #0f0;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Responsive adjustments */
    @media (max-width: 360px) {
      body {
        padding: 0.5em;
      }
      
      nav a {
        font-size: 0.8em;
        margin: 0 0.3em;
      }
      
      .dpad {
        grid-template-columns: repeat(3, 50px);
        grid-template-rows: repeat(3, 50px);
      }
      
      .dpad .remote-btn {
        min-height: 50px;
        font-size: 1.2em;
      }
    }
  </style>
</head>
<body>
  <nav>
    <a href="index.html">home</a>
    <a href="chemocam.html">chemocam</a>
    <a href="crespomize.html">crespomize</a>
    <a href="jakeysnakey.html">jakeysnakey</a>
    <a href="groatesque.html">groatesque</a>
    <a href="remote.html">remote</a>
  </nav>

  <div class="container">
    <h1>üì∫ sony remote</h1>
    
    <!-- Status bar -->
    <div class="status-bar">
      <div class="status-dot" id="statusDot"></div>
      <span class="status-text" id="statusText">not connected</span>
    </div>
    
    <!-- Settings panel -->
    <div class="settings-panel">
      <div class="settings-header" onclick="toggleSettings()">
        <h2>‚öôÔ∏è settings</h2>
        <span class="settings-toggle" id="settingsToggle">‚ñº</span>
      </div>
      <div class="settings-content" id="settingsContent">
        <div class="form-group">
          <label for="tvIp">TV IP Address:</label>
          <input type="text" id="tvIp" placeholder="192.168.1.xxx" autocomplete="off">
          <p class="help-text">Find this in your TV's Network Settings</p>
        </div>
        
        <div class="form-group">
          <label for="psk">Pre-Shared Key (PSK):</label>
          <input type="password" id="psk" placeholder="Enter PSK (default: 0000)" autocomplete="off">
          <p class="help-text">Set PSK in TV Settings ‚Üí Network ‚Üí Home Network Setup ‚Üí IP Control ‚Üí Authentication ‚Üí Normal and Pre-Shared Key</p>
        </div>
        
        <!-- Static IP Configuration -->
        <h3 style="margin-top: 1.5em; margin-bottom: 0.5em; font-size: 0.95em; border-top: 1px solid #0f0; padding-top: 1em;">üì° Static IP Configuration</h3>
        
        <div class="form-group">
          <label for="staticIp">IP Address:</label>
          <input type="text" id="staticIp" value="10.0.0.100" autocomplete="off">
        </div>
        
        <div class="form-group">
          <label for="subnetMask">Subnet Mask:</label>
          <input type="text" id="subnetMask" value="255.255.255.0" autocomplete="off">
        </div>
        
        <div class="form-group">
          <label for="defaultGateway">Default Gateway:</label>
          <input type="text" id="defaultGateway" value="10.0.0.1" autocomplete="off">
        </div>
        
        <div class="form-group">
          <label for="dnsPrimary">DNS Primary:</label>
          <input type="text" id="dnsPrimary" value="75.75.75.75" autocomplete="off">
        </div>
        
        <div class="form-group">
          <label for="dnsSecondary">DNS Secondary:</label>
          <input type="text" id="dnsSecondary" value="75.75.75.75" autocomplete="off">
        </div>
        
        <!-- WiFi Configuration -->
        <h3 style="margin-top: 1.5em; margin-bottom: 0.5em; font-size: 0.95em; border-top: 1px solid #0f0; padding-top: 1em;">üì∂ WiFi Configuration</h3>
        
        <div class="form-group">
          <label for="wifiSsid">SSID:</label>
          <input type="text" id="wifiSsid" value="Tyndale" autocomplete="off">
        </div>
        
        <div class="form-group">
          <label for="wifiPassword">Password:</label>
          <input type="password" id="wifiPassword" value="bacon2816" autocomplete="off">
        </div>
        
        <div class="form-group">
          <label for="wifiSecurity">Security Type:</label>
          <input type="text" id="wifiSecurity" value="WPA2-Personal" autocomplete="off" readonly>
        </div>
        
        <div class="form-group">
          <label for="wifiProtocol">Protocol:</label>
          <input type="text" id="wifiProtocol" value="Wi-Fi 6 (802.11ax)" autocomplete="off" readonly>
        </div>
        
        <div class="btn-row">
          <button class="btn" onclick="saveSettings()">üíæ Save</button>
          <button class="btn" onclick="testConnection()">üîå Test</button>
        </div>
        
        <div class="error-msg" id="settingsError"></div>
        <div class="success-msg" id="settingsSuccess"></div>
        
        <details class="cors-notice">
          <summary>‚ö†Ô∏è CORS Notice</summary>
          <p>Due to browser security restrictions, direct API calls to your TV may be blocked. For best results:</p>
          <p>1. Use this page on the same network as your TV</p>
          <p>2. Some browsers may require CORS extensions or a local proxy</p>
          <p>3. Sony TVs with newer firmware support CORS headers when PSK is configured</p>
        </details>
      </div>
    </div>
    
    <!-- Remote control -->
    <div class="remote">
      <!-- Power and Input -->
      <div class="remote-section">
        <div class="top-row">
          <button class="remote-btn power" data-cmd="AAAAAQAAAAEAAAAVAw==" title="Power">
            <span class="icon">‚èª</span>
          </button>
          <button class="remote-btn" data-cmd="AAAAAQAAAAEAAAAkAw==" title="Input">
            INPUT
          </button>
        </div>
      </div>
      
      <!-- Quick Apps - Vanderpump Rules -->
      <div class="remote-section">
        <div class="quick-apps">
          <button class="remote-btn peacock" id="vanderpumpBtn" title="Launch Peacock and play Vanderpump Rules">
            <span class="peacock-icon">ü¶ö</span>
            <span>VANDERPUMP RULES</span>
            <span class="app-subtitle">tap to launch on Peacock</span>
          </button>
        </div>
      </div>
      
      <!-- Volume and Channel -->
      <div class="remote-section">
        <div class="vol-ch-row">
          <div>
            <div class="vol-ch-label">VOL</div>
            <div class="vol-ch-btns">
              <button class="remote-btn" data-cmd="AAAAAQAAAAEAAAASAw==" title="Volume Up">+</button>
              <button class="remote-btn" data-cmd="AAAAAQAAAAEAAAATAw==" title="Volume Down">‚àí</button>
            </div>
          </div>
          
          <button class="remote-btn" data-cmd="AAAAAQAAAAEAAAAUAw==" title="Mute" style="height: 100%;">
            üîá MUTE
          </button>
          
          <div>
            <div class="vol-ch-label">CH</div>
            <div class="vol-ch-btns">
              <button class="remote-btn" data-cmd="AAAAAQAAAAEAAAAQAw==" title="Channel Up">‚ñ≤</button>
              <button class="remote-btn" data-cmd="AAAAAQAAAAEAAAARAw==" title="Channel Down">‚ñº</button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- D-pad Navigation -->
      <div class="remote-section">
        <div class="dpad-container">
          <div class="dpad">
            <div class="dpad-empty"></div>
            <button class="remote-btn" data-cmd="AAAAAQAAAAEAAAB0Aw==" title="Up">‚ñ≤</button>
            <div class="dpad-empty"></div>
            
            <button class="remote-btn" data-cmd="AAAAAQAAAAEAAAB2Aw==" title="Left">‚óÄ</button>
            <button class="remote-btn dpad-center" data-cmd="AAAAAQAAAAEAAABlAw==" title="Select">OK</button>
            <button class="remote-btn" data-cmd="AAAAAQAAAAEAAABnAw==" title="Right">‚ñ∂</button>
            
            <div class="dpad-empty"></div>
            <button class="remote-btn" data-cmd="AAAAAQAAAAEAAAB1Aw==" title="Down">‚ñº</button>
            <div class="dpad-empty"></div>
          </div>
        </div>
      </div>
      
      <!-- Navigation buttons -->
      <div class="remote-section">
        <div class="nav-row">
          <button class="remote-btn" data-cmd="AAAAAgAAAJcAAAAjAw==" title="Back">
            ‚Üê BACK
          </button>
          <button class="remote-btn" data-cmd="AAAAAQAAAAEAAABgAw==" title="Home">
            üè† HOME
          </button>
          <button class="remote-btn" data-cmd="AAAAAgAAAJcAAAA2Aw==" title="Options">
            ‚ãÆ OPT
          </button>
        </div>
      </div>
      
      <!-- Number pad -->
      <div class="remote-section">
        <div class="numpad">
          <button class="remote-btn" data-cmd="AAAAAQAAAAEAAAAAAw==">1</button>
          <button class="remote-btn" data-cmd="AAAAAQAAAAEAAAABAw==">2</button>
          <button class="remote-btn" data-cmd="AAAAAQAAAAEAAAACAw==">3</button>
          <button class="remote-btn" data-cmd="AAAAAQAAAAEAAAADAw==">4</button>
          <button class="remote-btn" data-cmd="AAAAAQAAAAEAAAAEAw==">5</button>
          <button class="remote-btn" data-cmd="AAAAAQAAAAEAAAAFAw==">6</button>
          <button class="remote-btn" data-cmd="AAAAAQAAAAEAAAAGAw==">7</button>
          <button class="remote-btn" data-cmd="AAAAAQAAAAEAAAAHAw==">8</button>
          <button class="remote-btn" data-cmd="AAAAAQAAAAEAAAAIAw==">9</button>
          <button class="remote-btn" data-cmd="AAAAAgAAAJcAAAA8Aw==">DOT</button>
          <button class="remote-btn" data-cmd="AAAAAQAAAAEAAAAJAw==">0</button>
          <button class="remote-btn" data-cmd="AAAAAgAAAJcAAAAyAw==">CC</button>
        </div>
      </div>
      
      <!-- Playback controls -->
      <div class="remote-section">
        <div class="playback-row">
          <button class="remote-btn" data-cmd="AAAAAgAAAJcAAAA4Aw==" title="Rewind">‚è™</button>
          <button class="remote-btn" data-cmd="AAAAAgAAAJcAAAAZAw==" title="Play">‚ñ∂</button>
          <button class="remote-btn" data-cmd="AAAAAgAAAJcAAAAaAw==" title="Pause">‚è∏</button>
          <button class="remote-btn" data-cmd="AAAAAgAAAJcAAAAYAw==" title="Stop">‚èπ</button>
          <button class="remote-btn" data-cmd="AAAAAgAAAJcAAAA5Aw==" title="Fast Forward">‚è©</button>
        </div>
      </div>
      
      <!-- Menu buttons -->
      <div class="remote-section">
        <div class="menu-row">
          <button class="remote-btn" data-cmd="AAAAAgAAAJcAAAAOAw==" title="Guide">
            üìã GUIDE
          </button>
          <button class="remote-btn" data-cmd="AAAAAgAAAJcAAAAPAw==" title="Info/Display">
            ‚ÑπÔ∏è INFO
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Sony Bravia IP Control
    const SonyTV = {
      ip: '',
      psk: '',
      connected: false,
      
      init() {
        this.loadSettings();
        this.setupButtons();
        this.updateStatus();
      },
      
      loadSettings() {
        try {
          const savedIp = localStorage.getItem('sonyTvIp');
          const savedPsk = localStorage.getItem('sonyTvPsk');
          
          if (savedIp) {
            this.ip = savedIp;
            document.getElementById('tvIp').value = savedIp;
          }
          
          if (savedPsk) {
            this.psk = savedPsk;
            document.getElementById('psk').value = savedPsk;
          }
          
          // If settings exist, close the settings panel
          if (savedIp && savedPsk) {
            // Settings panel starts closed if configured
          } else {
            // Open settings if not configured
            toggleSettings();
          }
        } catch (e) {
          console.error('Error loading settings:', e);
        }
      },
      
      saveSettings() {
        const ip = document.getElementById('tvIp').value.trim();
        const psk = document.getElementById('psk').value.trim() || '0000';
        
        const errorEl = document.getElementById('settingsError');
        const successEl = document.getElementById('settingsSuccess');
        
        // Validate IP address format
        const ipRegex = /^(\d{1,3}\.){3}\d{1,3}$/;
        if (!ip || !ipRegex.test(ip)) {
          errorEl.textContent = 'Please enter a valid IP address';
          errorEl.classList.add('show');
          successEl.classList.remove('show');
          return false;
        }
        
        try {
          localStorage.setItem('sonyTvIp', ip);
          localStorage.setItem('sonyTvPsk', psk);
          
          this.ip = ip;
          this.psk = psk;
          
          errorEl.classList.remove('show');
          successEl.textContent = 'Settings saved!';
          successEl.classList.add('show');
          
          setTimeout(() => successEl.classList.remove('show'), 2000);
          
          return true;
        } catch (e) {
          errorEl.textContent = 'Error saving settings: ' + e.message;
          errorEl.classList.add('show');
          return false;
        }
      },
      
      async testConnection() {
        if (!this.saveSettings()) return;
        
        const successEl = document.getElementById('settingsSuccess');
        const errorEl = document.getElementById('settingsError');
        
        successEl.textContent = 'Testing connection...';
        successEl.classList.add('show');
        errorEl.classList.remove('show');
        
        try {
          // Try to get power status
          const response = await this.sendRequest('system', 'getPowerStatus', '1.0', []);
          
          if (response && response.result) {
            this.connected = true;
            this.updateStatus();
            successEl.textContent = '‚úì Connected! TV is ' + (response.result[0].status === 'active' ? 'ON' : 'in standby');
          } else if (response && response.error) {
            throw new Error(response.error[1] || 'Unknown error');
          } else {
            // If we got a response but no result, it might still be working
            this.connected = true;
            this.updateStatus();
            successEl.textContent = '‚úì Connection established';
          }
        } catch (e) {
          this.connected = false;
          this.updateStatus();
          errorEl.textContent = 'Connection failed: ' + (e.message || 'Check IP and PSK');
          errorEl.classList.add('show');
          successEl.classList.remove('show');
        }
      },
      
      updateStatus() {
        const dot = document.getElementById('statusDot');
        const text = document.getElementById('statusText');
        
        if (this.connected) {
          dot.classList.add('connected');
          text.textContent = 'connected to ' + this.ip;
        } else if (this.ip) {
          dot.classList.remove('connected');
          text.textContent = 'configured: ' + this.ip;
        } else {
          dot.classList.remove('connected');
          text.textContent = 'not connected';
        }
      },
      
      setupButtons() {
        document.querySelectorAll('.remote-btn[data-cmd]').forEach(btn => {
          // Handle both touch and click
          btn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            this.handleButtonPress(btn);
          }, { passive: false });
          
          btn.addEventListener('touchend', () => {
            this.handleButtonRelease(btn);
          });
          
          btn.addEventListener('mousedown', () => {
            this.handleButtonPress(btn);
          });
          
          btn.addEventListener('mouseup', () => {
            this.handleButtonRelease(btn);
          });
          
          btn.addEventListener('mouseleave', () => {
            this.handleButtonRelease(btn);
          });
        });
      },
      
      handleButtonPress(btn) {
        btn.classList.add('pressed');
        const cmd = btn.dataset.cmd;
        if (cmd) {
          this.sendIRCC(cmd);
        }
      },
      
      handleButtonRelease(btn) {
        btn.classList.remove('pressed');
      },
      
      async sendIRCC(code) {
        if (!this.ip) {
          this.showError('Please configure TV IP address in settings');
          return;
        }
        
        try {
          // Sony IRCC (Infrared Compatible Control over IP)
          const url = `http://${this.ip}/sony/IRCC`;
          const body = `<?xml version="1.0"?>
<s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/" s:encodingStyle="http://schemas.xmlsoap.org/soap/encoding/">
  <s:Body>
    <u:X_SendIRCC xmlns:u="urn:schemas-sony-com:service:IRCC:1">
      <IRCCCode>${code}</IRCCCode>
    </u:X_SendIRCC>
  </s:Body>
</s:Envelope>`;
          
          const response = await fetch(url, {
            method: 'POST',
            headers: {
              'Content-Type': 'text/xml; charset=UTF-8',
              'X-Auth-PSK': this.psk || '0000',
              'SOAPACTION': '"urn:schemas-sony-com:service:IRCC:1#X_SendIRCC"'
            },
            body: body,
            mode: 'cors'
          });
          
          if (response.ok) {
            this.connected = true;
            this.updateStatus();
          }
        } catch (e) {
          console.error('IRCC error:', e);
          // Don't show error for every button press - just log it
          // The status will indicate connection issues
          this.connected = false;
          this.updateStatus();
        }
      },
      
      async sendRequest(service, method, version, params) {
        const url = `http://${this.ip}/sony/${service}`;
        const body = JSON.stringify({
          method: method,
          id: 1,
          params: params,
          version: version
        });
        
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Auth-PSK': this.psk || '0000'
          },
          body: body,
          mode: 'cors'
        });
        
        return response.json();
      },
      
      async launchApp(uri) {
        if (!this.ip) {
          this.showError('Please configure TV IP address in settings');
          return false;
        }
        
        try {
          // Sony Bravia API to launch an app
          const response = await this.sendRequest('appControl', 'setActiveApp', '1.0', [{
            uri: uri
          }]);
          
          if (response && response.result) {
            this.connected = true;
            this.updateStatus();
            return true;
          } else if (response && response.error) {
            console.error('App launch error:', response.error);
            return false;
          }
          return true;
        } catch (e) {
          console.error('App launch error:', e);
          return false;
        }
      },
      
      async launchVanderpumpRules() {
        if (!this.ip) {
          this.showError('Please configure TV IP address in settings');
          return;
        }
        
        const btn = document.getElementById('vanderpumpBtn');
        const originalContent = btn.innerHTML;
        btn.innerHTML = '<span class="loading"></span> Launching...';
        btn.classList.add('pressed');
        
        try {
          // Peacock app URI for Sony TVs
          // The URI format varies by TV model, trying common formats
          const peacockUris = [
            'com.peacocktv.peacockandroid',
            'com.sony.dtv.com.peacocktv.peacockandroid',
            'localapp://com.peacocktv.peacockandroid'
          ];
          
          let launched = false;
          
          // First, try to launch Peacock app
          for (const uri of peacockUris) {
            try {
              const response = await this.sendRequest('appControl', 'setActiveApp', '1.0', [{
                uri: uri
              }]);
              
              if (response && !response.error) {
                launched = true;
                break;
              }
            } catch (e) {
              console.log('Trying next URI...');
            }
          }
          
          if (!launched) {
            // Try alternative method - get app list first
            try {
              const appList = await this.sendRequest('appControl', 'getApplicationList', '1.0', []);
              if (appList && appList.result) {
                const peacockApp = appList.result[0].find(app => 
                  app.title.toLowerCase().includes('peacock') ||
                  app.uri.toLowerCase().includes('peacock')
                );
                
                if (peacockApp) {
                  await this.sendRequest('appControl', 'setActiveApp', '1.0', [{
                    uri: peacockApp.uri
                  }]);
                  launched = true;
                }
              }
            } catch (e) {
              console.error('Could not get app list:', e);
            }
          }
          
          if (launched) {
            this.connected = true;
            this.updateStatus();
            
            // After launching, we can try to navigate to Vanderpump Rules
            // Wait for app to load then send navigation commands
            btn.innerHTML = '<span class="peacock-icon">ü¶ö</span> Peacock launched!<span class="app-subtitle">Navigate to Vanderpump Rules</span>';
            
            setTimeout(() => {
              btn.innerHTML = originalContent;
              btn.classList.remove('pressed');
            }, 3000);
            
            // Note: Auto-navigating to specific content within the app is limited
            // The user will need to search for "Vanderpump Rules" in Peacock
            // or we could try sending search commands after a delay
          } else {
            btn.innerHTML = '<span class="peacock-icon">ü¶ö</span> Could not launch<span class="app-subtitle">Make sure Peacock is installed</span>';
            setTimeout(() => {
              btn.innerHTML = originalContent;
              btn.classList.remove('pressed');
            }, 3000);
          }
        } catch (e) {
          console.error('Vanderpump launch error:', e);
          btn.innerHTML = originalContent;
          btn.classList.remove('pressed');
          this.showError('Failed to launch Peacock');
        }
      },
      
      showError(message) {
        const errorEl = document.getElementById('settingsError');
        errorEl.textContent = message;
        errorEl.classList.add('show');
        setTimeout(() => errorEl.classList.remove('show'), 3000);
      }
    };
    
    // Settings panel toggle
    function toggleSettings() {
      const content = document.getElementById('settingsContent');
      const toggle = document.getElementById('settingsToggle');
      content.classList.toggle('open');
      toggle.classList.toggle('open');
    }
    
    // Global functions for buttons
    function saveSettings() {
      SonyTV.saveSettings();
    }
    
    function testConnection() {
      SonyTV.testConnection();
    }
    
    function launchVanderpump() {
      SonyTV.launchVanderpumpRules();
    }
    
    // Initialize on DOM ready
    document.addEventListener('DOMContentLoaded', () => {
      // Setup Vanderpump button
      const vanderpumpBtn = document.getElementById('vanderpumpBtn');
      if (vanderpumpBtn) {
        vanderpumpBtn.addEventListener('click', launchVanderpump);
        vanderpumpBtn.addEventListener('touchstart', (e) => {
          e.preventDefault();
          vanderpumpBtn.classList.add('pressed');
        }, { passive: false });
        vanderpumpBtn.addEventListener('touchend', () => {
          launchVanderpump();
        });
      }
      
      SonyTV.init();
    });
  </script>
</body>
</html>
